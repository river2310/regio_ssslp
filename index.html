<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regionalización Operativa</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script>
        window.React = React;
        window.ReactDOM = ReactDOM;
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d8f3dc; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #2d6a4f; }
        
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slide-right { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .animate-in { animation-duration: 0.4s; animation-fill-mode: both; }
        .fade-in { animation-name: fade-in; }
        .slide-up { animation-name: slide-up; }
        .slide-in-from-right { animation-name: slide-right; }
        
        body { background-color: #fcfdfc; margin: 0; padding: 0; overflow-x: hidden; }

        #map-display {
            height: 280px;
            width: 100%;
            border-radius: 1.5rem;
            z-index: 10;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 4px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        .leaflet-popup-content {
            margin: 12px;
            line-height: 1.4;
        }

        .modal-overlay {
            background-color: rgba(45, 106, 79, 0.4);
            backdrop-filter: blur(4px);
        }

        .contact-card:hover .contact-action {
            opacity: 1;
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQTyXeda4MphOJX65C0n5DYQamD0JqUtLIJJio7qDV_yZk6t5PQV04LSrRHoZv1udCCNPsufqw2vIZi/pub?gid=0&single=true&output=csv';
        const LOGO_URL = 'https://d3dac9gdq8t83x.cloudfront.net/media/static/images/hor-verde.png';
        const FAVICON_URL = 'https://d3dac9gdq8t83x.cloudfront.net/media/static/images/favicons/logo-verde.png';

        const COLORS = {
            primary: '#2d6a4f',
            secondary: '#1b4332',
            accent: '#c89e3a',
            background: '#fcfdfc',
            border: '#e8f5e9'
        };

        const Icono = ({ nombre, size = 24, className = "" }) => {
            if (!window.lucide || !window.lucide.icons) return null;
            const normalizedName = nombre.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
            const iconData = window.lucide.icons[nombre] || window.lucide.icons[normalizedName];
            if (!iconData) return <div style={{ width: size, height: size }} className="bg-slate-100 rounded-sm" />;
            return (
                <svg
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                >
                    {iconData.map((tagData, index) => {
                        const [tagName, attrs] = tagData;
                        const Tag = tagName;
                        return <Tag key={index} {...attrs} />;
                    })}
                </svg>
            );
        };

        const ContactItem = ({ initials, name, position, email }) => (
            <div className="contact-card flex items-center gap-4 p-5 rounded-3xl hover:bg-white hover:shadow-md transition-all duration-300 group cursor-default border border-transparent hover:border-slate-100">
                <div className="w-12 h-12 rounded-full bg-[#d8f3dc] text-[#2d6a4f] flex items-center justify-center font-black text-sm shadow-sm group-hover:bg-[#2d6a4f] group-hover:text-white transition-colors duration-300 flex-shrink-0">
                    {initials}
                </div>
                <div className="flex-1 min-w-0">
                    <p className="text-[13px] font-black text-slate-800 leading-tight uppercase tracking-tight truncate">{name}</p>
                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1 whitespace-normal leading-relaxed">{position}</p>
                    <a href={`mailto:${email}`} className="text-[11px] font-medium text-[#2d6a4f] hover:underline flex items-center gap-1 mt-1.5 lowercase">
                        <Icono nombre="Mail" size={12} />
                        {email}
                    </a>
                </div>
                <div className="contact-action opacity-0 transform translate-x-2 transition-all duration-300 hidden md:block">
                    <a href={`mailto:${email}`} className="p-3 bg-white border border-slate-100 rounded-full text-[#c89e3a] shadow-sm hover:shadow-md hover:bg-slate-50 transition-all">
                        <Icono nombre="ExternalLink" size={18} />
                    </a>
                </div>
            </div>
        );

        const ModalLocalidades = ({ isOpen, onClose, unidadNombre, localidades, clues }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay animate-in fade-in duration-300">
                    <div className="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden animate-in slide-up duration-500 max-h-[85vh] flex flex-col">
                        <div className="bg-[#2d6a4f] p-8 text-white flex justify-between items-start">
                            <div>
                                <div className="flex items-center gap-2 mb-2">
                                    <Icono nombre="Hospital" size={16} className="text-[#c89e3a]" />
                                    <span className="text-[10px] font-black uppercase tracking-widest text-[#d8f3dc]">Cobertura de Unidad</span>
                                </div>
                                <h3 className="text-xl font-black uppercase leading-tight">{unidadNombre}</h3>
                                <p className="text-[10px] font-mono text-white/60 mt-1 uppercase tracking-widest">CLUES: {clues}</p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-colors">
                                <Icono nombre="X" size={24} />
                            </button>
                        </div>
                        
                        <div className="p-8 overflow-y-auto custom-scrollbar flex-1 bg-slate-50">
                            <div className="flex items-center gap-2 mb-6">
                                <Icono nombre="MapPin" size={18} className="text-[#c89e3a]" />
                                <span className="text-[11px] font-black uppercase tracking-[0.2em] text-[#2d6a4f]">Localidades vinculadas ({localidades.length})</span>
                            </div>
                            <div className="grid gap-3">
                                {localidades.sort((a,b) => a.nombre.localeCompare(b.nombre)).map((loc, idx) => (
                                    <div key={idx} className="bg-white p-4 rounded-2xl border border-slate-200 flex justify-between items-center group hover:border-[#2d6a4f] transition-all shadow-sm">
                                        <div>
                                            <p className="text-xs font-black text-slate-700 uppercase group-hover:text-[#2d6a4f] transition-colors">{loc.nombre}</p>
                                            <div className="flex items-center gap-1.5 mt-1">
                                                <Icono nombre="Users" size={10} className="text-[#c89e3a]" />
                                                <p className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Población: {loc.pobTotal.toLocaleString()}</p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-0.5">Clave GEO</p>
                                            <p className="text-[10px] font-mono font-bold text-slate-500">{loc.cveGeo}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div className="p-6 border-t border-slate-100 text-center bg-white">
                            <button onClick={onClose} className="px-8 py-3 bg-[#2d6a4f] text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-[#1b4332] transition-all shadow-lg active:scale-95">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LocalidadMap = ({ lat, lng, title, cveGeo, munName, cveMun }) => {
            const leafletMap = useRef(null);
            useEffect(() => {
                if (!lat || !lng) return;
                if (!leafletMap.current) {
                    leafletMap.current = L.map('map-display', { center: [lat, lng], zoom: 14, scrollWheelZoom: false });
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(leafletMap.current);
                } else {
                    leafletMap.current.setView([lat, lng], 14);
                }
                leafletMap.current.eachLayer((layer) => { if (layer instanceof L.Marker) leafletMap.current.removeLayer(layer); });
                const popupContent = `<div style="font-family: sans-serif;"><div style="color: #2d6a4f; font-weight: 900; font-size: 13px; text-transform: uppercase; margin-bottom: 4px; border-bottom: 1px solid #e2e8f0; padding-bottom: 4px;">${title}</div><div style="margin-bottom: 6px;"><div style="color: #64748b; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">Municipio</div><div style="color: #1e293b; font-size: 11px; font-weight: 700;">${munName} <span style="color: #c89e3a;">(${cveMun || 'S/C'})</span></div></div><div><div style="color: #64748b; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">Clave Geoestadística</div><div style="color: #2d6a4f; font-family: monospace; font-size: 11px; font-weight: 700;">${cveGeo || 'N/A'}</div></div></div>`;
                L.marker([lat, lng]).addTo(leafletMap.current).bindPopup(popupContent).openPopup();
            }, [lat, lng, title, cveGeo, munName, cveMun]);
            return (
                <div className="space-y-3 pt-4 border-t border-slate-100 animate-in fade-in duration-700">
                    <div className="flex items-center gap-2 text-[#2d6a4f]">
                        <Icono nombre="Map" size={16} className="text-[#c89e3a]" />
                        <span className="text-[10px] font-black uppercase tracking-widest text-slate-500">Ubicación Geográfica</span>
                    </div>
                    <div id="map-display" className="border-2 border-slate-100 shadow-inner overflow-hidden"></div>
                </div>
            );
        };

        const IndicatorCard = ({ label, value, icon, color }) => (
            <div className="bg-white p-8 rounded-[2.5rem] shadow-lg border border-slate-50 flex items-center gap-6 transition-all hover:shadow-2xl hover:-translate-y-1 border-b-[6px] border-transparent hover:border-[#c89e3a] group">
                <div className={`${color} p-5 rounded-2xl text-white shadow-lg transform group-hover:rotate-6 transition-transform duration-500`}>
                    {icon}
                </div>
                <div>
                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1 leading-none">{label}</p>
                    <p className="text-3xl font-black text-[#1a1a1a] tracking-tighter">{value || '0'}</p>
                </div>
            </div>
        );

        const MetricBox = ({ label, value, color }) => (
            <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:border-[#c89e3a] transition-all">
                <p className="text-[8px] font-black text-slate-400 uppercase mb-2 tracking-widest leading-none text-balance">{label}</p>
                <p className={`text-xl font-black ${color} tracking-tighter leading-none`}>
                    {Number(value || 0).toLocaleString()}
                </p>
            </div>
        );

        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('LOCALIDAD');
            const [selectedRecord, setSelectedRecord] = useState(null);
            
            const [modalState, setModalState] = useState({ isOpen: false, unit: null, localities: [], clues: '' });

            useEffect(() => {
                const link = document.querySelector("link[rel~='icon']") || document.createElement('link');
                link.type = 'image/png';
                link.rel = 'shortcut icon';
                link.href = FAVICON_URL;
                document.getElementsByTagName('head')[0].appendChild(link);
                document.title = "Regionalización Operativa";
                fetchData();
            }, []);

            useEffect(() => {
                setSelectedRecord(null);
                setSearchTerm('');
            }, [filterType]);

            const fetchData = async () => {
                setLoading(true);
                setError(null);
                try {
                    const response = await fetch(CSV_URL);
                    if (!response.ok) throw new Error('Error de red');
                    const text = await response.text();
                    parseCSV(text);
                } catch (err) {
                    setError("Error de conexión con el catálogo remoto.");
                    setLoading(false);
                }
            };

            const parseCSV = (text) => {
                try {
                    const lines = text.split(/\r?\n/);
                    if (lines.length < 2) return;
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').replace(/^\uFEFF/, ''));
                    const result = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const obj = {};
                        const currentline = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        headers.forEach((header, index) => {
                            obj[header] = currentline[index] ? currentline[index].replace(/"/g, '').trim() : '';
                        });
                        result.push(obj);
                    }
                    setData(result);
                    setLoading(false);
                } catch (err) {
                    setError("Error al procesar el archivo CSV regional.");
                    setLoading(false);
                }
            };

            const normalizeText = (text) => 
                text ? text.toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9 ]/g, "") : "";

            const processedResults = useMemo(() => {
                if (data.length === 0) return [];
                const lowerSearch = normalizeText(searchTerm);

                if (filterType === 'LOCALIDAD') {
                    const groupedLoc = {};
                    data.forEach(item => {
                        const locName = item['NOMBRE LOC'] || item['NOMBRE_LOC'] || '';
                        if (!lowerSearch || normalizeText(locName).includes(lowerSearch)) {
                            const munName = item['NOMBRE MUN'] || item['NOMBRE_MUN'] || 'N/A';
                            const unit = item.UNIDAD || 'N/A';
                            const key = normalizeText(`${locName}-${munName}-${unit}`);
                            if (!groupedLoc[key]) {
                                groupedLoc[key] = {
                                    type: 'INDIVIDUAL_LOC',
                                    title: locName,
                                    municipio_display: munName,
                                    UNIDAD: unit,
                                    CLUES: item.CLUES,
                                    nomInst: item.nom_inst || item.NOM_INST || 'N/A',
                                    jur: item.jur_mun || item.JUR_MUN || item.JUR,
                                    jur_um: item.JUR,
                                    jurName: item.JUR_NOMBRE || item.NOMBRE,
                                    cve_geo: item.cve_geo,
                                    cve_mun: item.CVE_MUN_ATIENDE,
                                    lat: parseFloat(item.latitud),
                                    lng: parseFloat(item.longitud),
                                    pob_total: 0, pob_s_derecho: 0, pob_imss: 0, pob_issste: 0, pob_imss_bien: 0, pob_bien: 0
                                };
                            }
                            groupedLoc[key].pob_total += Number(item.pob_total) || 0;
                            groupedLoc[key].pob_s_derecho += Number(item.pob_s_derecho) || 0;
                            groupedLoc[key].pob_imss += Number(item.pob_imss) || 0;
                            groupedLoc[key].pob_issste += Number(item.pob_issste) || 0;
                            groupedLoc[key].pob_imss_bien += Number(item.pob_imss_bien) || 0;
                            groupedLoc[key].pob_bien += Number(item.pob_bien) || 0;
                        }
                    });
                    return Object.values(groupedLoc).slice(0, 50);
                }

                if (filterType === 'MUNICIPIO') {
                    const groupedMun = {};
                    data.forEach(item => {
                        const munName = item['NOMBRE MUN'] || item['NOMBRE_MUN'] || '';
                        if (!lowerSearch || normalizeText(munName).includes(lowerSearch)) {
                            const key = normalizeText(munName);
                            if (!groupedMun[key]) {
                                groupedMun[key] = {
                                    type: 'GROUPED_MUN',
                                    title: munName,
                                    jur: item.jur_mun || item.JUR_MUN || item.JUR,
                                    jurName: item.JUR_NOMBRE || item.NOMBRE,
                                    cve_mun: item.CVE_MUN_ATIENDE,
                                    unidadesData: {},
                                    pob_total: 0, pob_s_derecho: 0, pob_imss: 0, pob_issste: 0, pob_imss_bien: 0, pob_bien: 0
                                };
                            }
                            if (item.UNIDAD) {
                                const clues = item.CLUES || 'S/C';
                                if (!groupedMun[key].unidadesData[clues]) {
                                    groupedMun[key].unidadesData[clues] = {
                                        nombre: item.UNIDAD,
                                        inst: item.nom_inst || item.NOM_INST || 'S/I',
                                        clues: clues,
                                        localidades: []
                                    };
                                }
                                groupedMun[key].unidadesData[clues].localidades.push({
                                    nombre: item['NOMBRE LOC'] || item['NOMBRE_LOC'],
                                    cveGeo: item.cve_geo,
                                    pobTotal: Number(item.pob_total) || 0
                                });
                            }
                            groupedMun[key].pob_total += Number(item.pob_total) || 0;
                            groupedMun[key].pob_s_derecho += Number(item.pob_s_derecho) || 0;
                            groupedMun[key].pob_imss += Number(item.pob_imss) || 0;
                            groupedMun[key].pob_issste += Number(item.pob_issste) || 0;
                            groupedMun[key].pob_imss_bien += Number(item.pob_imss_bien) || 0;
                            groupedMun[key].pob_bien += Number(item.pob_bien) || 0;
                        }
                    });
                    return Object.values(groupedMun).slice(0, 50);
                }

                if (filterType === 'UNIDAD') {
                    const groupedUnits = {};
                    data.forEach(item => {
                        const unitName = item.UNIDAD || '';
                        const clues = item.CLUES || 'S/C';
                        if (!lowerSearch || normalizeText(unitName).includes(lowerSearch) || normalizeText(clues).includes(lowerSearch)) {
                            if (!groupedUnits[clues]) {
                                groupedUnits[clues] = {
                                    type: 'GROUPED_UNIT_INDIVIDUAL',
                                    title: unitName,
                                    clues: clues,
                                    inst: item.nom_inst || item.NOM_INST || 'S/I',
                                    jur: item.JUR,
                                    jurName: item.JUR_NOMBRE || item.NOMBRE,
                                    localities: [],
                                    pob_total: 0, pob_s_derecho: 0, pob_imss: 0, pob_issste: 0, pob_imss_bien: 0, pob_bien: 0
                                };
                            }
                            groupedUnits[clues].localities.push({
                                nombre: item['NOMBRE LOC'] || item['NOMBRE_LOC'],
                                cveGeo: item.cve_geo,
                                pobTotal: Number(item.pob_total) || 0
                            });
                            groupedUnits[clues].pob_total += Number(item.pob_total) || 0;
                            groupedUnits[clues].pob_s_derecho += Number(item.pob_s_derecho) || 0;
                            groupedUnits[clues].pob_imss += Number(item.pob_imss) || 0;
                            groupedUnits[clues].pob_issste += Number(item.pob_issste) || 0;
                            groupedUnits[clues].pob_imss_bien += Number(item.pob_imss_bien) || 0;
                            groupedUnits[clues].pob_bien += Number(item.pob_bien) || 0;
                        }
                    });
                    return Object.values(groupedUnits).slice(0, 50);
                }
                return [];
            }, [data, searchTerm, filterType]);

            const stats = useMemo(() => {
                if (data.length === 0) return null;
                return {
                    municipios: new Set(data.map(d => d['NOMBRE MUN'] || d['NOMBRE_MUN']).filter(Boolean)).size,
                    pobTotal: data.reduce((acc, curr) => acc + (Number(curr.pob_total) || 0), 0)
                };
            }, [data]);

            if (loading) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen gap-8">
                        <img src={FAVICON_URL} alt="Cargando" className="h-20 w-auto animate-bounce" />
                        <p className="font-black text-[#2d6a4f] uppercase tracking-[0.4em] text-xl animate-pulse">Sincronizando</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-[#fcfdfc] text-[#1b1c1b] font-sans selection:bg-emerald-100 selection:text-emerald-900">
                    <ModalLocalidades 
                        isOpen={modalState.isOpen} 
                        onClose={() => setModalState({ ...modalState, isOpen: false })}
                        unidadNombre={modalState.unit}
                        localidades={modalState.localities}
                        clues={modalState.clues}
                    />

                    <header className="bg-[#2d6a4f] text-white shadow-xl border-b-4 border-[#c89e3a] sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-6">
                            <div className="flex items-center gap-6">
                                <div className="bg-white p-2 rounded-xl shadow-inner transform hover:scale-105 transition-transform duration-300">
                                    <img src={LOGO_URL} alt="Logo" className="h-14 w-auto object-contain" />
                                </div>
                                <div>
                                    <div className="mb-2 space-y-0.5">
                                        <p className="text-[9px] md:text-[11px] font-bold uppercase tracking-wide text-[#d8f3dc]/90 leading-tight">Dirección de Planeación, Evaluación y Proyectos Especiales</p>
                                        <p className="text-[9px] md:text-[11px] font-bold uppercase tracking-wide text-[#d8f3dc]/80 leading-tight">Subdirección de Informática y Estadísticas en Salud</p>
                                    </div>
                                    <h1 className="text-xl md:text-2xl font-black tracking-tight uppercase leading-none text-balance">Regionalización Operativa</h1>
                                    <div className="flex items-center gap-2 mt-2">
                                        <span className="h-1.5 w-1.5 rounded-full bg-[#95d5b2] animate-pulse"></span>
                                        <p className="text-[10px] font-bold uppercase tracking-[0.2em] text-[#d8f3dc]">Sistema de consulta</p>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={fetchData} className="p-2.5 bg-[#1b4332] hover:bg-[#40916c] rounded-xl border border-white/10 active:scale-95 shadow-md">
                                    <Icono nombre="RefreshCw" size={18} />
                                </button>
                                <div className="h-8 w-[1px] bg-white/10 mx-1"></div>
                                <div className="bg-white/10 px-4 py-2 rounded-xl flex items-center gap-3 border border-white/5 shadow-sm">
                                    <span className="text-[10px] font-black uppercase tracking-widest leading-none text-white/80">ver. 21.10.2025</span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 md:p-8 space-y-12">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <IndicatorCard label="Municipios en Red" value={stats?.municipios} icon={<Icono nombre="Globe" size={24} />} color="bg-[#2d6a4f]" />
                            <IndicatorCard label="Población Bajo Cobertura" value={stats?.pobTotal.toLocaleString()} icon={<Icono nombre="Users" size={24} />} color="bg-[#1b4332]" />
                        </div>

                        <div className="bg-white p-5 rounded-[2.5rem] shadow-xl border border-slate-100 flex flex-col md:flex-row gap-5 items-center">
                            <div className="relative flex-1 w-full">
                                <div className="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300">
                                    <Icono nombre="Search" size={22} />
                                </div>
                                <input 
                                    type="text"
                                    placeholder={`Consultar ${filterType === 'UNIDAD' ? 'unidad o clues' : filterType.toLowerCase()}...`}
                                    className="w-full pl-14 pr-12 py-4 rounded-[1.5rem] border-2 border-slate-50 bg-[#f9fafb] focus:bg-white focus:ring-4 focus:ring-[#d8f3dc] focus:border-[#2d6a4f] outline-none transition-all font-bold uppercase text-slate-700 placeholder:normal-case placeholder:font-normal"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                                {searchTerm && (
                                    <button onClick={() => setSearchTerm('')} className="absolute right-6 top-1/2 -translate-y-1/2 text-slate-300 hover:text-[#2d6a4f]">
                                        <Icono nombre="X" size={20} />
                                    </button>
                                )}
                            </div>
                            <div className="flex bg-[#f1f8e9] p-1.5 rounded-[1.8rem] w-full md:w-auto border border-[#d8f3dc]">
                                {['LOCALIDAD', 'MUNICIPIO', 'UNIDAD'].map((type) => (
                                    <button key={type} onClick={() => setFilterType(type)} className={`flex-1 md:flex-none px-6 py-3 rounded-[1.3rem] text-[10px] font-black transition-all uppercase tracking-widest ${filterType === type ? 'bg-white text-[#2d6a4f] shadow-md border border-[#e8f5e9]' : 'text-slate-500 hover:text-[#2d6a4f]'}`}>
                                        {type === 'UNIDAD' ? 'UNIDAD / CLUES' : type}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <div className="lg:col-span-7 space-y-6">
                                <section>
                                    <h3 className="font-black uppercase text-[10px] tracking-[0.2em] text-[#2d6a4f] px-3 mb-4">Listado Operativo ({processedResults.length})</h3>
                                    <div className="grid gap-4 max-h-[650px] overflow-y-auto pr-3 custom-scrollbar">
                                        {processedResults.map((item, idx) => (
                                            <div key={idx} onClick={() => setSelectedRecord(item)} className={`group p-6 rounded-[2rem] border-2 transition-all cursor-pointer relative overflow-hidden ${selectedRecord === item ? 'bg-[#f1f8e9] border-[#2d6a4f] shadow-md' : 'bg-white border-transparent shadow-sm hover:border-[#c89e3a] hover:shadow-lg'}`}>
                                                <div className="flex justify-between items-center gap-6">
                                                    <div className="flex-1">
                                                        <div className="flex flex-wrap items-center gap-2 mb-2">
                                                            <span className="text-[9px] font-black bg-[#2d6a4f] text-white px-3 py-0.5 rounded-full uppercase tracking-tighter">{item.type === 'GROUPED_UNIT_INDIVIDUAL' ? 'UNIDAD MÉDICA' : filterType}</span>
                                                            <span className="text-[9px] font-black text-[#c89e3a] uppercase tracking-widest bg-slate-50 px-2 py-0.5 rounded-md border border-slate-100 text-balance">JUR {item.jur}: {item.jurName}</span>
                                                            {item.cve_geo && <span className="text-[9px] font-black text-emerald-600 uppercase tracking-widest bg-emerald-50 px-2 py-0.5 rounded-md border border-emerald-100">GEO: {item.cve_geo}</span>}
                                                            {item.clues && <span className="text-[9px] font-black text-amber-600 uppercase tracking-widest bg-amber-50 px-2 py-0.5 rounded-md border border-amber-100">CLUES: {item.clues}</span>}
                                                        </div>
                                                        <h4 className="font-black text-[#2d3436] text-xl leading-tight uppercase group-hover:text-[#2d6a4f] transition-colors">{item.title}</h4>
                                                        <p className="text-xs text-slate-400 font-bold uppercase tracking-tight flex items-center gap-2 mt-1">
                                                            <Icono nombre={item.type === 'GROUPED_UNIT_INDIVIDUAL' ? "ShieldCheck" : "MapPin"} size={14} className="text-[#c89e3a]" />
                                                            {item.type === 'INDIVIDUAL_LOC' ? (
                                                                <span className="truncate">{item.municipio_display} | {item.UNIDAD}</span>
                                                            ) : item.type === 'GROUPED_UNIT_INDIVIDUAL' ? (
                                                                <span className="truncate">{item.inst}</span>
                                                            ) : (
                                                                'Concentrado Municipal'
                                                            )}
                                                        </p>
                                                    </div>
                                                    <div className="text-right pl-6 border-l border-[#e8f5e9]">
                                                        <p className="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-0.5">Población</p>
                                                        <p className="text-2xl font-black text-[#2d6a4f] tracking-tighter leading-none">{item.pob_total.toLocaleString()}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            </div>

                            <div className="lg:col-span-5">
                                <div className="sticky top-[100px]">
                                    {selectedRecord ? (
                                        <div className="bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 overflow-hidden animate-in slide-in-from-right duration-500">
                                            <div className="bg-gradient-to-br from-[#2d6a4f] to-[#1b4332] p-10 text-white relative">
                                                <div className="absolute top-0 right-0 p-4 opacity-10 filter brightness-200">
                                                    <img src={FAVICON_URL} alt="" className="h-32 w-auto" />
                                                </div>
                                                <div className="flex items-center gap-2 mb-4">
                                                    <Icono nombre="ShieldCheck" size={18} className="text-[#c89e3a]" />
                                                    <span className="text-[10px] font-black uppercase tracking-[0.3em] text-[#d8f3dc]">Ficha Operativa</span>
                                                </div>
                                                <h4 className="font-black text-3xl leading-tight uppercase mb-8 text-balance">{selectedRecord.title}</h4>
                                                <div className="space-y-4 pt-6 border-t border-white/10">
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                        <div className="flex items-start gap-3 bg-white/5 p-3 rounded-xl border border-white/5">
                                                            <Icono nombre="Map" size={16} className="text-amber-300 mt-0.5" />
                                                            <div>
                                                                <p className="text-[8px] font-black text-amber-200 uppercase tracking-widest">Jurisdicción Sanitaria</p>
                                                                <p className="text-[10px] font-bold uppercase">{selectedRecord.jur} - {selectedRecord.jurName}</p>
                                                            </div>
                                                        </div>
                                                        {(selectedRecord.cve_geo || selectedRecord.cve_mun || selectedRecord.clues) && (
                                                            <div className="flex items-start gap-3 bg-white/5 p-3 rounded-xl border border-white/5">
                                                                <Icono nombre="Fingerprint" size={16} className="text-emerald-300 mt-0.5" />
                                                                <div>
                                                                    <p className="text-[8px] font-black text-emerald-200 uppercase tracking-widest">
                                                                        {selectedRecord.type === 'INDIVIDUAL_LOC' ? 'Clave Geo' : selectedRecord.type === 'GROUPED_UNIT_INDIVIDUAL' ? 'CLUES' : 'Clave Mun'}
                                                                    </p>
                                                                    <p className="text-[10px] font-mono font-bold tracking-widest">
                                                                        {selectedRecord.type === 'INDIVIDUAL_LOC' ? selectedRecord.cve_geo : selectedRecord.type === 'GROUPED_UNIT_INDIVIDUAL' ? selectedRecord.clues : selectedRecord.cve_mun}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="p-10 space-y-10 max-h-[550px] overflow-y-auto custom-scrollbar bg-[#fcfdfc]">
                                                {(selectedRecord.type === 'GROUPED_MUN' || selectedRecord.type === 'GROUPED_UNIT_INDIVIDUAL') && (
                                                    <section>
                                                        <h5 className="text-[10px] font-black text-[#2d6a4f] uppercase tracking-[0.2em] mb-5 flex items-center gap-3">
                                                            <Icono nombre={selectedRecord.type === 'GROUPED_MUN' ? "Stethoscope" : "MapPin"} size={16} className="text-[#c89e3a]" /> 
                                                            {selectedRecord.type === 'GROUPED_MUN' ? `Infraestructura (${Object.keys(selectedRecord.unidadesData).length})` : `Localidades en Cobertura (${selectedRecord.localities.length})`}
                                                        </h5>
                                                        <div className="grid gap-3">
                                                            {selectedRecord.type === 'GROUPED_MUN' ? (
                                                                Object.values(selectedRecord.unidadesData).sort((a,b) => a.nombre.localeCompare(b.nombre)).map((u, i) => (
                                                                    <div key={i} onClick={() => setModalState({ isOpen: true, unit: u.nombre, localities: u.localities, clues: u.clues })} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:border-[#2d6a4f] hover:shadow-md transition-all group/unit cursor-pointer relative overflow-hidden">
                                                                        <div className="absolute right-4 top-1/2 -translate-y-1/2 opacity-0 group-hover/unit:opacity-100 transition-opacity"><Icono nombre="ChevronRight" size={16} className="text-[#c89e3a]" /></div>
                                                                        <p className="text-[10px] font-black text-slate-700 uppercase leading-tight mb-1 group-hover/unit:text-[#2d6a4f] pr-6">{u.nombre}</p>
                                                                        <div className="flex flex-wrap gap-x-3 gap-y-0.5 text-[9px] font-bold text-slate-400 uppercase tracking-tighter">
                                                                            <div className="flex items-center gap-1"><Icono nombre="Hash" size={10} className="text-[#c89e3a]" />CLUES: {u.clues}</div>
                                                                            <div className="flex items-center gap-1"><Icono nombre="ShieldCheck" size={10} className="text-[#c89e3a]" />{u.inst}</div>
                                                                        </div>
                                                                    </div>
                                                                ))
                                                            ) : (
                                                                selectedRecord.localities.sort((a,b) => a.nombre.localeCompare(b.nombre)).map((loc, i) => (
                                                                    <div key={i} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center group/loc">
                                                                        <div>
                                                                            <p className="text-[10px] font-black text-slate-700 uppercase leading-tight mb-1">{loc.nombre}</p>
                                                                            <div className="flex items-center gap-1.5"><Icono nombre="Users" size={10} className="text-[#c89e3a]" /><p className="text-[9px] font-bold text-slate-400">Población: {loc.pobTotal.toLocaleString()}</p></div>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <p className="text-[9px] font-black text-slate-300 uppercase mb-0.5">Clave GEO</p>
                                                                            <p className="text-[10px] font-mono font-bold text-slate-500">{loc.cveGeo}</p>
                                                                        </div>
                                                                    </div>
                                                                ))
                                                            )}
                                                        </div>
                                                    </section>
                                                )}
                                                
                                                <section>
                                                    <h5 className="text-[10px] font-black text-[#2d6a4f] uppercase tracking-[0.2em] mb-6 flex items-center gap-3">
                                                        <Icono nombre="Activity" size={16} className="text-[#c89e3a]" /> Perfil de Cobertura
                                                    </h5>
                                                    <div className="space-y-6">
                                                        <div className="bg-[#2d6a4f] p-6 rounded-[1.5rem] text-white shadow-xl">
                                                            <p className="text-[9px] font-black uppercase tracking-widest opacity-60 mb-1">Habitantes Nominales</p>
                                                            <p className="text-4xl font-black tracking-tighter">{Number(selectedRecord.pob_total).toLocaleString()}</p>
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <MetricBox label="Sin derechohabiencia" value={selectedRecord.pob_s_derecho} color="text-slate-500" />
                                                            <MetricBox label="IMSS" value={selectedRecord.pob_imss} color="text-[#2d6a4f]" />
                                                            <MetricBox label="ISSSTE" value={selectedRecord.pob_issste} color="text-[#1a3a5f]" />
                                                            <MetricBox label="IMSS BIENESTAR" value={selectedRecord.pob_imss_bien} color="text-[#065f46]" />
                                                            <MetricBox label="Otra derechohabiencia" value={selectedRecord.pob_bien} color="text-[#c89e3a]" />
                                                        </div>
                                                    </div>
                                                </section>

                                                {selectedRecord.type === 'INDIVIDUAL_LOC' && selectedRecord.lat && selectedRecord.lng && (
                                                    <LocalidadMap lat={selectedRecord.lat} lng={selectedRecord.lng} title={selectedRecord.title} cveGeo={selectedRecord.cve_geo} munName={selectedRecord.municipio_display} cveMun={selectedRecord.cve_mun} />
                                                )}
                                            </div>
                                            <div className="p-6 bg-slate-50 text-center border-t border-slate-100"></div>
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-[3rem] p-16 border-4 border-dashed border-[#e8f5e9] text-center flex flex-col items-center justify-center min-h-[500px]">
                                            <img src={FAVICON_URL} alt="Visitando Corazones" className="h-20 w-auto opacity-40 grayscale mb-8" />
                                            <h4 className="text-[#2d6a4f] font-black text-xl mb-3 uppercase tracking-widest leading-none">Exploración Regional</h4>
                                            <p className="text-slate-400 text-[10px] font-bold leading-relaxed max-w-[240px] mx-auto uppercase tracking-widest opacity-60 italic text-balance text-balance">Seleccione un registro para visualizar el perfil demográfico operativo.</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* SECCIÓN ACTUALIZADA: RESPONSABLES (Fuera de la cuadrícula lateral) */}
                        <section className="bg-white p-10 rounded-[3rem] shadow-xl border border-slate-100 animate-in fade-in duration-1000 mt-8">
                            <div className="flex items-center gap-3 mb-10 px-4">
                                <div className="p-3 bg-[#d8f3dc] text-[#2d6a4f] rounded-2xl shadow-sm">
                                    <Icono nombre="Users" size={24} />
                                </div>
                                <div>
                                    <h3 className="font-black uppercase text-xs tracking-[0.3em] text-[#2d6a4f]">Responsables de la plataforma y administración de datos</h3>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <ContactItem 
                                    initials="OG" 
                                    name="L.C. Omar Granados Piña" 
                                    position="Director de Planeación, Evaluación y Proyectos Especiales" 
                                    email="dir.planeacion@slpsalud.gob.mx" 
                                />
                                <ContactItem 
                                    initials="DE" 
                                    name="Ing. Dorian Escamilla Sauceda" 
                                    position="Subdirector de Informática y Estadísticas en Salud" 
                                    email="sub.informatica@slpsalud.gob.mx" 
                                />
                                <ContactItem 
                                    initials="FM" 
                                    name="Fernando Montoya Rivera" 
                                    position="Desarrollador de la herramienta y Responsable de Información Geográfica y CLUES" 
                                    email="clues.estadistica@slpsalud.gob.mx" 
                                />
                            </div>
                        </section>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
